name: Validate Commit Messages
on: [push, pull_request]

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get commit range
        id: commit-range
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "range=${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "range=${{ github.event.before }}..${{ github.event.after }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate commit messages
        run: |
          echo "üîç Analyzing commits in range: ${{ steps.commit-range.outputs.range }}"
          echo "----------------------------------------"
          
          INVALID_COMMITS=()
          while IFS= read -r commit_hash; do
            message=$(git log --format=%B -n 1 "$commit_hash")
            branch_name=$(git branch --contains "$commit_hash" | grep -v "HEAD" | head -n 1 | xargs)
            
            if [[ "$message" =~ ^Merge && ! "$message" =~ ^merge: ]]; then
              message="merge: ${message#Merge }"
            fi
            
            if ! echo "$message" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|merge)(\([a-z0-9-]+\))?(!)?: .+"; then
              INVALID_COMMITS+=("$commit_hash")
              echo "‚ùå Invalid commit found:"
              echo "   Hash: ${commit_hash:0:8}"
              echo "   Message: $message"
              echo "   Branch: $branch_name"
              echo "   Error: Invalid format. Expected: <type>[optional scope]: <description>"
              echo "----------------------------------------"
            fi
          done < <(git log ${{ steps.commit-range.outputs.range }} --format=%H)
          
          if [ ${#INVALID_COMMITS[@]} -ne 0 ]; then
            echo "‚ùå Found ${#INVALID_COMMITS[@]} invalid commit(s)"
            echo ""
            echo "üìù Commit Message Format Guide:"
            echo "----------------------------------------"
            echo "Format: <type>[optional scope]: <description>"
            echo ""
            echo "Examples:"
            echo "‚úÖ fix(validation): correct commit message parser"
            echo "‚úÖ feat: add new user authentication"
            echo "‚úÖ docs(api): update endpoint documentation"
            echo "‚úÖ merge: branch 'feature/xyz' into main"
            echo ""
            echo "Common Types:"
            echo "- feat     ‚Üí New feature"
            echo "- fix      ‚Üí Bug fix"
            echo "- docs     ‚Üí Documentation changes"
            echo "- style    ‚Üí Code style changes"
            echo "- refactor ‚Üí Code refactoring"
            echo "- perf     ‚Üí Performance improvements"
            echo "- test     ‚Üí Test updates"
            echo "- chore    ‚Üí Maintenance tasks"
            echo "- merge    ‚Üí Merge commits"
            exit 1
          else
            echo "‚úÖ All commit messages are valid!"
          fi